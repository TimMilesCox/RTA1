MASMX 7r3A Build 12
3/proton.msm
*EOF*
  :                            26 	$list
  :                            27 
  :                            28 ROTARY		$equ	1
  :                            29 RX_THREADS	$equ	8
  :                            30 RX_PORTS	$equ	8000
  :                            31 RX_RANGE	$equ	RX_PORTS/RX_THREADS
  :                            32 
  :                            33 DATA	$equ	120
  :                            34 	$set_option	"z"
  :                            35 
  :                            36 $(69::,b)
45:000000                     +37 so	$socket
45:000002                     +37 
45:000004                     +37 
45:000005                     +37 
45:000006                     +37 
45:000007                     +37 
45:000005                     +37 
45:000006                     +37 
45:000007                     +37 
  :                            38 
  :                            39 $(66::,x)
42:000000                     +40 tlist	tbank
42:000001                     +40 
42:000002                     +40 
42:000003                     +40 
42:000004                     +40 
42:000005                     +40 
42:000006                     +40 
42:000007                     +40 
42:000008                     +40 
42:000009                     +40 
42:00000A                     +40 
42:00000B                     +40 
42:00000C                     +40 
42:00000D                     +40 
42:00000E                     +40 
42:00000F                     +40 
42:000010                     +40 
42:000011                     +40 
42:000012                     +40 
42:000013                     +40 
42:000014                     +40 
42:000015                     +40 
42:000016                     +40 
42:000017                     +40 
42:000018                     +40 
42:000019                     +40 
42:00001A                     +40 
42:00001B                     +40 
42:00001C                     +40 
42:00001D                     +40 
42:00001E                     +40 
42:00001F                     +40 
42:000020                     +40 
42:000021                     +40 
42:000022                     +40 
42:000023                     +40 
42:000024                     +40 
42:000025                     +40 
42:000026                     +40 
42:000027                     +40 
42:000028                     +40 
42:000029                     +40 
42:00002A                     +40 
42:00002B                     +40 
42:00002C                     +40 
42:00002D                     +40 
42:00002E                     +40 
42:000030                     +40 
42:000032                     +40 
42:000034                     +40 
42:000036                     +40 
42:000038                     +40 
42:000039                     +40 
42:00003A                     +40 
42:00003B                     +40 
42:00003C                     +40 
42:00003D                     +40 
42:00003E                     +40 
42:00003F                     +40 
42:000040                     +40 
42:000041                     +40 
42:000042                     +40 
42:000043                     +40 
42:000044                     +40 
42:000045                     +40 
42:000046                     +40 
42:000048                     +40 
42:00004A                     +40 
42:00004C                     +40 
42:00004E                     +40 
42:000050                     +40 
42:000051                     +40 
42:000052                     +40 
42:000053                     +40 
42:000054                     +40 
42:000055                     +40 
42:000056                     +40 
42:000057                     +40 
  :                            41 
  :                            42 $(66::,x)
42:000000                     +43 transmission	tcp_connection
42:000001                     +43 
42:000002                     +43 
42:000003                     +43 
42:000004                     +43 
42:000005                     +43 
42:000006                     +43 
42:000008                     +43 
42:00000A                     +43 
42:00000C                     +43 
42:00000E                     +43 
42:000010                     +43 
42:000011                     +43 
42:000012                     +43 
42:000013                     +43 
42:000014                     +43 
42:000015                     +43 
42:000016                     +43 
42:000017                     +43 
  :                            44 
  :                            45 $(71::,sp)
47:000000                     +46 dgram	datagram
47:000001                     +46 
47:000002                     +46 
47:000003                     +46 
47:000004                     +46 
47:000005                     +46 
47:000006                     +46 
47:000008                     +46 
  :                            47 
  :                            48 $(70::,fp)
  :                            49 descriptor acw
  :                            50 
  :                            51 $(3:03000/$3)
  :                            52 
03:003000  000003 000010 000A00 000000 000A00 00000A
                              +53 route_10	5-2, 16, 0a00, 0, 0a00, 000a:H
03:003006  000003 000010 000A01 000000 000000 000000
                              +54 route_10_1	5-2, 16, 0a01, 0, 0, 0:H
03:00300C  000003 000010 000A02 000000 000A00 00000A
                              +55 route_10_2	5-2, 16, 0a02, 0, 0a00, 000a:H
  :                            56 
03:003012  000000              +57 chain_again	0
  :                            58 
03:003013  000000              +59 command_byte	0
03:003014  000000              +60 bytes		0
03:003015  002800              +61 port		10240
03:003016  002800              +62 restart_local_port	10240
03:003017  002800              +63 local_port	10240
03:003018  000400              +64 ports	1024
03:003019  000400              +65 restart_ports	1024
03:00301A  002800              +66 restart_port	10240
03:00301B  000014              +67 connections	20
03:00301C  000000              +68 connections_prolog	0	. make a 48-bit integer for quick add
03:00301D  000014              +69 connections_pro	20
03:00301E  000000 000000        +70 connections_total	0L
03:003020  000000 00000A        +71 interval		10L
03:003022  000000 000000        +72 tx_interval		0L
  :                            73 
  :                            74 	$res	120
  :                            75 
03:00309C  0A0100 012800        +76 local_restart	$net_socket	10.1.0.1:10240
03:00309E  0A0200 012800        +77 remote_restart	$net_socket	10.2.0.1:10240
  :                            78 
  :                            79 socket_addresses
03:0030A0  0A0100 012800        +80 local_socket	$net_socket	10.1.0.1:10240
03:0030A2  0A0200 012800        +81 remote_socket	$net_socket	10.2.0.1:10240
  :                            82 
  :                            83 local_socket_name	$res	3
  :                            84 remote_socket_name	$res	3
  :                            85 
03:0030AA  000000 000000        +86 payload_segments	0L
03:0030AC  000000 000000        +87 payload_sent		0L
  :                            88 
03:0030AE  000001              +89 times	1
  :                            90 data	$res	DATA//3
  :                            91 message	$res	DATA//3
  :                            92 
03:0030FF  000000 000000 000000 000000 000000 000000 000000 000000
                              +93 ?	$do	4,command_word(?)	0o
03:003107  000000 000000 000000 000000 000000 000000 000000 000000
                              +93 
03:00310F  000000 000000 000000 000000 000000 000000 000000 000000
                              +93 
03:003117  000000 000000 000000 000000 000000 000000 000000 000000
                              +93 
  :                            94 
  :                            95 $(0:0/$0)
  :                            96 
  :                            97 __BASE	$equ	PROTON_P
  :                            98 __PRIORITY $equ	0
  :                            99 
[+0001]18
[+0000]18*/30
00:000040  000050 000000 001000 000000
                              +100 	catalog
00:000044  4D0003              +100 
00:000045  000000              +100 
[+0002]30
00:000046  000000 000000        +100 
[+0000]18
[+0001]18*/48
00:000048  800040 000000 009000 FFFFFF 000000 000000 000050 000000
                              +100 
  :                            101 
                                	$base_d	$zenith(3)-03000	1024	1024	1024	1024	1024	1024	1024	1024	;
                                					1024	1024	1024	1024	1024	1024	1024	1024	;
                                					1024	1024	1024	1024	1024	1024	1024	1024	;
00:000050  60207F              +105 					1024	1024	1024	1024	1024	1024	1024	1024	1024
00:000051  340003              +105 
00:000052  40207E              +105 
00:000053  6D0004              +105 
00:000054  54C001              +105 
00:000055  F6005A              +105 
00:000056  600002              +105 
00:000057  34D000              +105 
00:000058  6CD001              +105 
00:000059  B60054              +105 
00:00005A  60032C              +105 
00:00005B  75007A              +105 
00:00005C  60032D              +105 
00:00005D  20000E              +105 
  :                            106 
  :                            107 	$if	0
  :                            108 	la	4096,,xi
  :                            109 	ii	BANK$
  :                            110 	push	a			. no stack_dependent references
  :                            111 	sabr	SPRING_Q
  :                            112 	$endif
  :                            113 
00:00005E  9F032E              +114 	c	(seg$load)	0,,xi	(proton_data:L),,long
00:00005F  FD0000              +114 
00:000060  FCF003              +114 
00:000061  FF0330              +114 
00:000062  38000F              +114 
  :                            115 
  :                            116 	$if	0
  :                            117 	pop	spring_page		. certainly none until here
  :                            118 	$endif
  :                            119 
00:000063  5D3000              +120 	ly	route_10,,xi
00:000064  FF0331              +121 	call	(__route_config)
00:000065  5D3006              +122 	ly	route_10_1,,xi
00:000066  FF0331              +123 	call	(__route_config)
00:000067  5D300C              +124 	ly	route_10_2,,xi
00:000068  FF0331              +125 	call	(__route_config)
  :                            126 
  :                            127 	$if	ROTARY
  :                            128 
  :                            129 rx_start* $proc
  :                            130 	ql	(rthreads:rx_thread, 0, rxport_range(?), THREAD_FP(?+1)q)
  :                            131 	ii	THREAD$
  :                            132 
  :                            133 	$if	1
  :                            134 	lb	$3("proton_rx(":'0'+?///10:")":0),,xi
  :                            135 	$else
                                	lb	?-1+$0(names	proton_rx(1) proton_rx(2) proton_rx(3) proton_rx(4)	;
  :                            137 				proton_rx(5) proton_rx(6) proton_rx(7) proton_rx(8))
  :                            138 	$endif
  :                            139 
  :                            140 	ii	TAG$
  :                            141 	$end
  :                            142 
00:000069  4F0332              +143 ?	$do	RX_THREADS,	rx_start
00:00006A  750047              +143 
00:00006B  6D3155              +143 
00:00006C  750049              +143 
00:00006D  4F0336              +143 
00:00006E  750047              +143 
00:00006F  6D315A              +143 
00:000070  750049              +143 
00:000071  4F033A              +143 
00:000072  750047              +143 
00:000073  6D315F              +143 
00:000074  750049              +143 
00:000075  4F033E              +143 
00:000076  750047              +143 
00:000077  6D3164              +143 
00:000078  750049              +143 
00:000079  4F0342              +143 
00:00007A  750047              +143 
00:00007B  6D3169              +143 
00:00007C  750049              +143 
00:00007D  4F0346              +143 
00:00007E  750047              +143 
00:00007F  6D316E              +143 
00:000080  750049              +143 
00:000081  4F034A              +143 
00:000082  750047              +143 
00:000083  6D3173              +143 
00:000084  750049              +143 
00:000085  4F034E              +143 
00:000086  750047              +143 
00:000087  6D3178              +143 
00:000088  750049              +143 
  :                            144 
  :                            145 	$else
  :                            146 	ql	(rxthread, 0, 0, THREAD_FP(2)q)
  :                            147 	ii	THREAD$
  :                            148 	lb	$3("rxthread":0),,xi
  :                            149 	ii	TAG$
  :                            150 	$endif
  :                            151 
00:000089  FD317D              +152 request	printf	$3("proton>":0),,xi
00:00008A  FD0001              +152 
00:00008B  FCF002              +152 
00:00008C  FF0352              +152 
00:00008D  38000F              +152 
00:00008E  FD0001              +153 	fflush	stdout
00:00008F  FCF001              +153 
00:000090  FF0353              +153 
00:000091  38000F              +153 
00:000092  FD0078              +154 poll	fgets	data,,xi	DATA,,xi	stdin
00:000093  FD30AF              +154 
00:000094  FD0000              +154 
00:000095  FCF003              +154 
00:000096  FF0354              +154 
00:000097  38000F              +154 
00:000098  160018              +154 
00:000099  1D0018              +154 
00:00009A  EE009D              +154 
00:00009B  CE009D              +154 
00:00009C  6530AF              +154 
  :                            155 
00:00009D  EE01F3              +156 	jnb	away			. or broke
00:00009E  D600A1              +157 	jnza	evaluate		. stdin timed out
00:00009F  75005F              +158 	ii	GUARD$
00:0000A0  B60092              +159 	j	poll			. it was meant to block
  :                            160 
  :                            161 evaluate
  :                            162 extract* $proc
  :                            163 	lb	command_word(?),,xi
  :                            164 	la	24,,xi
  :                            165 	call	(tokena)
  :                            166 	$end
  :                            167 
00:0000A1  6D30AF              +168 	lb	data,,xi
00:0000A2  FF0355              +169 	call	(rstream_starta)
00:0000A3  6D30FF              +170 ?	$do	3,	extract
00:0000A4  650018              +170 
00:0000A5  FF0356              +170 
00:0000A6  6D3107              +170 
00:0000A7  650018              +170 
00:0000A8  FF0356              +170 
00:0000A9  6D310F              +170 
00:0000AA  650018              +170 
00:0000AB  FF0356              +170 
  :                            171 
00:0000AC  CF30FF              +172 	dl	command_word(1)
00:0000AD  480357              +173 	lk	(-1*/$word-$byte)
  :                            174 	
00:0000AE  AF0358              +175 	mta	('+'*/$word-$byte)
00:0000AF  B60132              +176 	j	traffic?
  :                            177 
                                	sscanf	data,,xi	$3("%::%s":0),,xi	command_word(2),,xi	;
00:0000B0  FD310F              +179 							command_word(3),,xi
00:0000B1  FD3107              +179 
00:0000B2  FD3180              +179 
00:0000B3  FD30AF              +179 
00:0000B4  FCF004              +179 
00:0000B5  FF0359              +179 
00:0000B6  38000F              +179 
  :                            180 
00:0000B7  553107              +181 	lx	command_word(2),,xi
00:0000B8  C5FFFE              +182 	aa	-2,,xi
00:0000B9  5E00CC              +183 	jnc	remote_chosen				. local socket goes here
  :                            184 							. remote socket scan goes here
  :                            185 
                                	sscanf	command_word(2),,xi	$3("%:/%s":0),,xi	command_word(4),,xi	;
00:0000BA  FD30FF              +187 								command_word(1),,xi
00:0000BB  FD3117              +187 
00:0000BC  FD3182              +187 
00:0000BD  FD3107              +187 
00:0000BE  FCF004              +187 
00:0000BF  FF0359              +187 
00:0000C0  38000F              +187 
  :                            188 
00:0000C1  FD3117              +189 	lc	netascan	command_word(4),,xi
00:0000C2  FCF001              +189 
00:0000C3  3E0318              +189 
00:0000C4  38000F              +189 
00:0000C5  C7309C              +190 	ds	local_restart
  :                            191 
00:0000C6  FD30FF              +192 	lc	netascan	command_word(1),,xi
00:0000C7  FCF001              +192 
00:0000C8  3E0318              +192 
00:0000C9  38000F              +192 
00:0000CA  C7309E              +193 	ds	remote_restart	
  :                            194 
00:0000CB  55310F              +195 	lx	command_word(3),,xi
  :                            196 
  :                            197 remote_chosen
                                	sscanf	x	$3("%d/%d/%d %d":0),,xi		restart_port,,xi	;
                                							restart_ports,,xi	;
                                							connections_pro,,xi	;
00:0000CC  FD3017              +201 							local_port,,xi
00:0000CD  FD301D              +201 
00:0000CE  FD3019              +201 
00:0000CF  FD301A              +201 
00:0000D0  FD3184              +201 
00:0000D1  F80002              +201 
00:0000D2  FCF006              +201 
00:0000D3  FF0359              +201 
00:0000D4  38000F              +201 
00:0000D5  E601F3              +202 	jna	away
00:0000D6  C60089              +203 	jza	request
  :                            204 
00:0000D7  30301E              +205 	z	connections_total
00:0000D8  30301F              +206 	z	connections_total+1
  :                            207 
00:0000D9  680004              +208 	anu	5,,xi
00:0000DA  DD0005              +208 
00:0000DB  7E00DE              +209 	jc	local_port_given
00:0000DC  60301A              +210 	la	restart_port
00:0000DD  203017              +211 	sa	local_port
  :                            212 
  :                            213 local_port_given
00:0000DE  CF309E              +214 	dl	remote_restart
00:0000DF  48035A              +215 	lk	(00FFFF)
00:0000E0  BF301A              +216 	mlb	restart_port
00:0000E1  C7309E              +217 	ds	remote_restart
00:0000E2  C70006              +218 	ds	6
00:0000E3  CF309C              +219 	dl	local_restart
00:0000E4  BF3017              +220 	mlb	local_port
00:0000E5  C7309C              +221 	ds	local_restart
00:0000E6  4730A0              +222 	qs	socket_addresses
  :                            223 
  :                            224 
00:0000E7  603017              +225 	la	local_port
00:0000E8  203121              +226 	sa	sockets:first
00:0000E9  203123              +227 	sa	sockets:actual
00:0000EA  C03019              +228 	aa	restart_ports
00:0000EB  203122              +229 	sa	sockets:limit
00:0000EC  603019              +230 	la	restart_ports
00:0000ED  C50004              +231 	aa	4,,xi
00:0000EE  203124              +232 	sa	sockets:span
00:0000EF  203125              +233 	sa	sockets:span_restart
  :                            234 
00:0000F0  603019              +235 	la	restart_ports
00:0000F1  203018              +236 	sa	ports	
  :                            237 
  :                            238 connect_multiple
00:0000F2  60301D              +239 	la	connections_pro
00:0000F3  20301B              +240 	sa	connections
  :                            241 
  :                            242 connect_next
00:0000F4  FDFFFF              +243 	c	(__connect)	socket_addresses,,float	-1,,xi
00:0000F5  8F30A0              +243 
00:0000F6  FCF005              +243 
00:0000F7  FF035B              +243 
00:0000F8  38000F              +243 
  :                            244 
00:0000F9  A60100              +245 	jpa	connect_a1
00:0000FA  9F0004              +246 	printf	$3("connect return %ld":10:0),,xi	a,,long
00:0000FB  FD3188              +246 
00:0000FC  FD0001              +246 
00:0000FD  FCF004              +246 
00:0000FE  FF0352              +246 
00:0000FF  38000F              +246 
  :                            247 
  :                            248 connect_a1
00:000100  CF30A2              +249 	dl	remote_socket
00:000101  D7035C              +250 	da	(1*/16d)
00:000102  C70006              +251 	ds	6
00:000103  CF30A0              +252 	dl	local_socket		. send from 1 port
00:000104  D7035C              +253 	da	(1*/16d)		. multiple network addresses
00:000105  4730A0              +254 	qs	socket_addresses
  :                            255 
00:000106  1F301B              +256 	dec	connections
00:000107  70301B              +257 	tz	connections
00:000108  B600F4              +258 	j	connect_next
  :                            259 
00:000109  48035A              +260 	lk	(00FFFF)
00:00010A  1730A3              +261 	inc	remote_socket+1
00:00010B  CF309E              +262 	dl	remote_restart
00:00010C  BF30A3              +263 	mlb	remote_socket+1
00:00010D  C70006              +264 	ds	6
  :                            265 
00:00010E  1730A1              +266 	inc	local_socket+1		. up port
00:00010F  CF309C              +267 	dl	local_restart		. rewind network address
00:000110  BF30A1              +268 	mlb	local_socket+1
00:000111  4730A0              +269 	qs	socket_addresses
  :                            270 
00:000112  CF301C              +271 	dl	connections_prolog
00:000113  D7301E              +272 	da	connections_total
00:000114  C7301E              +273 	ds	connections_total
  :                            274 
00:000115  9F0004              +275 	printf	$3("":CR:" %ld ":0),,xi	a,,long
00:000116  FD318F              +275 
00:000117  FD0001              +275 
00:000118  FCF004              +275 
00:000119  FF0352              +275 
00:00011A  38000F              +275 
00:00011B  FD0001              +276 	fflush	stdout
00:00011C  FCF001              +276 
00:00011D  FF0353              +276 
00:00011E  38000F              +276 
  :                            277 
00:00011F  CF3020              +278 	dl	interval
00:000120  7C0122              +279 	jdz	no_interval		. default 10ms change command ^ msecs
00:000121  75005B              +280 	ii	TWAIT$			. in case of single-core
  :                            281 					. let ip thread receive some SYN_ACKs
  :                            282 no_interval
  :                            283 
00:000122  1F3018              +284 	dec	ports
00:000123  703018              +285 	tz	ports
00:000124  B600F2              +286 	j	connect_multiple
  :                            287 
00:000125  CF3020              +288 	dl	interval		. extra time
  :                            289 
00:000126  DE0128              +290 	jnzb	intervalnz		. stab at a wait time
00:000127  680019              +291 	lb	dl(15*1000d)		. reasonable..generous
  :                            292 					. will get doubled to 30sec
  :                            293 intervalnz
00:000128  360001              +294 	dsl	1
00:000129  75005B              +295 	ii	TWAIT$			. for the last batch to connect
  :                            296 
00:00012A  60301A              +297         la      restart_port
00:00012B  C03019              +298         aa      restart_ports
00:00012C  F80004              +299         lc      states  restart_port    a
00:00012D  F8301A              +299 
00:00012E  FCF002              +299 
00:00012F  3E02DF              +299 
00:000130  38000F              +299 
  :                            300 
00:000131  B60089              +301 	j	request
  :                            302 
  :                            303 traffic?
00:000132  AF035E              +304 	mta	('>'*/$word-$byte)
00:000133  B60170              +305 	j	close?
  :                            306 
                                	sscanf	data,,xi	$3("%s %d %s":0),,xi	command_byte,,xi	;
                                							times,,xi		;
00:000134  FD3107              +309 							command_word(2),,xi
00:000135  FD30AE              +309 
00:000136  FD3013              +309 
00:000137  FD3192              +309 
00:000138  FD30AF              +309 
00:000139  FCF005              +309 
00:00013A  FF0359              +309 
00:00013B  38000F              +309 
  :                            310 
  :                            311 next_time
00:00013C  1F30AE              +312 	dec	times
00:00013D  7830AE              +313 	tp	times
00:00013E  B60089              +314 	j	request
  :                            315 
00:00013F  603016              +316 	la	restart_local_port
00:000140  203017              +317 	sa	local_port
00:000141  603019              +318 	la	restart_ports
00:000142  203018              +319 	sa	ports
  :                            320 
  :                            321 next_port
00:000143  FD3107              +322 	sprintf	message,,xi	$3("%d %s":0),,xi	times	command_word(2),,xi
00:000144  F830AE              +322 
00:000145  FD3195              +322 
00:000146  FD30D7              +322 
00:000147  FCF004              +322 
00:000148  FF035F              +322 
00:000149  38000F              +322 
  :                            323 
  :                            324 	$if	0			. sprintf length result checks out
  :                            325 	c	(strlen)	message,,xi
  :                            326 	$endif
  :                            327 
00:00014A  203014              +328 	sa	bytes
00:00014B  603017              +329 	la	local_port
00:00014C  FF0360              +330 	call	(connection_array)
00:00014D  B60161              +331 	j	port_thru
  :                            332 
00:00014E  500361              +333 	lx	(BSOCKET*/12++tlist:chain(1))		. point @ chain head, don't load it
  :                            334 
  :                            335 next_chain
00:00014F  103012              +336 	sx	chain_again
00:000150  B60159              +337 	j	chain_along
  :                            338 
  :                            339 traffic!
00:000151  603014              +340 	la	bytes
00:000152  6D30D7              +341 	lb	message,,xi
00:000153  3E01F4              +342 	lcal	msg_tcp		
  :                            343 
00:000154  E60159              +344 	jna	chain_along
00:000155  C60159              +345 	jza	chain_along
00:000156  CF0362              +346 	dl	(1L)
00:000157  D730AC              +347 	da	payload_sent
00:000158  C730AC              +348 	ds	payload_sent
  :                            349 
  :                            350 chain_along
00:000159  50A000              +351 	lx	0, x
00:00015A  700002              +352 	tz	x
00:00015B  B60151              +353 	j	traffic!
  :                            354 
00:00015C  503012              +355 	lx	chain_again
00:00015D  850001              +356 	ax	1,,xi
00:00015E  400364              +357 	lr	(BSOCKET*/12++tlist:chain(CHAINS)+1)
00:00015F  F60161              +358 	jxge	port_thru
00:000160  B6014F              +359 	j	next_chain
  :                            360 
  :                            361 port_thru
  :                            362 	$if	1
  :                            363 
00:000161  CF3022              +364 	dl	tx_interval
00:000162  7C0164              +365 	jdz	traffic_thru
00:000163  75005B              +366 	ii	TWAIT$
  :                            367 traffic_thru
  :                            368 
  :                            369 	$else	0		.	MODEL_REQUEST_RESPONSE
  :                            370 
  :                            371 	la	local_port
  :                            372 	call	(connection_array)
  :                            373 	j	ported
  :                            374 
  :                            375 	ly	(BSOCKET*/12++tlist:connection_block(1):receiveq:head)
  :                            376 port_sense
  :                            377 	ii	YIELD$
  :                            378 	tnz	0, y
  :                            379 	j	port_sense
  :                            380 
  :                            381 readback
  :                            382 	call	(hvsocket_readq)
  :                            383 	jza	ported
  :                            384 
  :                            385 	lcal	qreadq
  :                            386 
  :                            387 	dl	(1d)
  :                            388 	da	payload_segments
  :                            389 	ds	payload_segments
  :                            390 	j	readback
  :                            391 	tz	0, y
  :                            392 	j	readback
  :                            393 	dl	(5d)
  :                            394 	ii	TWAIT$
  :                            395 	tz	0, y
  :                            396 	j	readback
  :                            397 
  :                            398 ported	printf	$3("rx @ socket %ld":LF:0),,xi	payload_segments,,long
  :                            399 
  :                            400 	dl	payload_segments
  :                            401 	da	total_rx
  :                            402 	ds	total_rx
  :                            403 	dsr	48
  :                            404 	ds	payload_segments
  :                            405 
  :                            406 	$endif	
  :                            407 
00:000164  173017              +408 	inc	local_port
00:000165  1F3018              +409 	dec	ports
  :                            410 
00:000166  703018              +411 	tz	ports
00:000167  B60143              +412 	j	next_port
  :                            413 
  :                            414 	$if	0	.	MODEL_REQUEST_RESPONSE
  :                            415 	printf	$3("%d tx %ld rx %ld":LF:0),,xi	times	payload_sent,,long	total_rx,,long
  :                            416 	$else
00:000168  9F30AC              +417 	printf	$3("%d tx %ld":10:0),,xi	times	payload_sent,,long
00:000169  F830AE              +417 
00:00016A  FD3197              +417 
00:00016B  FD0001              +417 
00:00016C  FCF005              +417 
00:00016D  FF0352              +417 
00:00016E  38000F              +417 
  :                            418 	$endif
  :                            419 
00:00016F  B6013C              +420 	j	next_time
  :                            421 
  :                            422 
00:000170  AF0365              +423 close?	mta	('<'*/$word-$byte)
00:000171  B601B7              +424 	j	anomaly?
  :                            425 
00:000172  603019              +426 	la	restart_ports
00:000173  203018              +427 	sa	ports
  :                            428 
00:000174  603016              +429 	la	restart_local_port
  :                            430 
  :                            431 close_array
00:000175  203017              +432 	sa	local_port
00:000176  FF0360              +433 	call	(connection_array)
00:000177  B60183              +434 	j	close_next_port
  :                            435 
00:000178  580361              +436 	ly	(BSOCKET*/12++tlist:chain(1))
00:000179  44B020              +437 	lr	CHAINS, y, i
  :                            438 
  :                            439 close_chain
00:00017A  500003              +440 	lx	y
00:00017B  B6017D              +441 	j	close_chain_along
  :                            442 close_chain_next
00:00017C  0FA001              +443 	n	transmission:state
  :                            444 close_chain_along
00:00017D  50A000              +445 	lx	transmission:next
00:00017E  700002              +446 	tz	x
00:00017F  B6017C              +447 	j	close_chain_next
  :                            448 	
00:000180  8D0001              +449 	ay	1,,xi
00:000181  FE0183              +450 	jyge	close_next_port
00:000182  B6017A              +451 	j	close_chain
  :                            452 
  :                            453 close_next_port
00:000183  603017              +454 	la	local_port
00:000184  C50001              +455 	aa	1,,xi
00:000185  1F3018              +456 	dec	ports
00:000186  703018              +457 	tz	ports
00:000187  B60175              +458 	j	close_array
  :                            459 
00:000188  B60089              +460 	j	request
  :                            461 
  :                            462 .	subroutines of anomal?
  :                            463 
  :                            464 rx_segment_awaiting_sequence
00:000189  F8A012              +465 	lc	waiting_segment $3(" rx segment awaiting sequence":0),,xi	transmission:deferq:head
00:00018A  FD319B              +465 
00:00018B  FCF002              +465 
00:00018C  3E01A0              +465 
00:00018D  38000F              +465 
  :                            466 
  :                            467 segment_untransmitted
00:00018E  F8A014              +468 	lc	waiting_segment	$3(" UNTRANSMITTED":0),,xi	transmission:q4window:head
00:00018F  FD31A5              +468 
00:000190  FCF002              +468 
00:000191  3E01A0              +468 
00:000192  38000F              +468 
00:000193  350000              +469 	lret	0
  :                            470 
  :                            471 segment_waiting_ack
00:000194  F8A016              +472 	lc	waiting_segment	$3(" awaiting TCP_ACK":0),,xi	transmission:q4ack:head
00:000195  FD31AA              +472 
00:000196  FCF002              +472 
00:000197  3E01A0              +472 
00:000198  38000F              +472 
00:000199  350000              +473 	lret	0
  :                            474 
  :                            475 rx_traffic_at_socket
00:00019A  F8A010              +476 	lc	waiting_segment $3(" rx traffic at socket":0),,xi	transmission:receiveq:head
00:00019B  FD31B0              +476 
00:00019C  FCF002              +476 
00:00019D  3E01A0              +476 
00:00019E  38000F              +476 
00:00019F  350000              +477 	lret	0
  :                            478 
  :                            479 waiting_segment	$tree	
                                	$head_near	 params(reason_p,	int		;
                                				q_p,		int	)	;
                                								;
                                			scalars(save_rkxy,	float,	r	;
00:0001A0  8F0000              +484 				save_bsocket,	int		)
00:0001A1  FD0000              +484 
  :                            485 
00:0001A2  054000              +486 	on	see$1
00:0001A3  60106F              +487 	la	ABT+BSOCKET
00:0001A4  0D4000              +488 	off	see$1
00:0001A5  20F000              +489 	sa	save_bsocket
                                	printf	$3("":LF:"connection %x:%x has segment[s] %s":LF:0),,xi	;
                                							save_bsocket	;
                                							x		;
00:0001A6  F8F007              +493 							reason_p
00:0001A7  F80002              +493 
00:0001A8  F8F002              +493 
00:0001A9  FD31B8              +493 
00:0001AA  FD0001              +493 
00:0001AB  FCF005              +493 
00:0001AC  FF0352              +493 
00:0001AD  38000F              +493 
  :                            494 
00:0001AE  F8F008              +495 	lc	display_segment	q_p
00:0001AF  FCF001              +495 
00:0001B0  3E0257              +495 
00:0001B1  38000F              +495 
00:0001B2  50F003              +496 	lx	save_rkxy+2
00:0001B3  3E02B3              +497 	lcal	display_connection
  :                            498 
00:0001B4  380004              +499 	pop	a
00:0001B5  870000              +500 	qpop	r
00:0001B6  350000              +501 	lret	0
  :                            502 
  :                            503 	$root
  :                            504 
  :                            505 anomaly?
00:0001B7  AF0366              +506 	mta	('?'*/$word-$byte)
00:0001B8  B601DC              +507 	j	states?
  :                            508 
00:0001B9  60301A              +509 	la	restart_port
00:0001BA  203018              +510 	sa	ports
00:0001BB  603016              +511 	la	restart_local_port
  :                            512 
  :                            513 search_port
00:0001BC  203017              +514 	sa	local_port
00:0001BD  FF0360              +515 	call	(connection_array)
00:0001BE  B601D6              +516 	j	search_next_port
  :                            517 
00:0001BF  500364              +518 	lx	(BSOCKET*/12++tlist:connection_block(1))
00:0001C0  70A010              +519 	tz	transmission:receiveq:head
00:0001C1  3E019A              +520 	lcal	rx_traffic_at_socket
  :                            521 
00:0001C2  580361              +522 	ly	(BSOCKET*/12++tlist:chain(1))
00:0001C3  44B020              +523 	lr	CHAINS, y, i
  :                            524 
  :                            525 search_chain
00:0001C4  500003              +526 	lx	y
00:0001C5  B601D0              +527 	j	search_chain_tail
  :                            528 
  :                            529 search_chain_next
00:0001C6  70A012              +530 	tz	transmission:deferq
00:0001C7  3E0189              +531 	lcal	rx_segment_awaiting_sequence
00:0001C8  70A014              +532 	tz	transmission:q4window
00:0001C9  3E018E              +533 	lcal	segment_untransmitted
00:0001CA  70A016              +534 	tz	transmission:q4ack
00:0001CB  3E0194              +535 	lcal	segment_waiting_ack
00:0001CC  60A001              +536 	la	transmission:state
00:0001CD  C5FFFB              +537 	aa	-TCP_ESTABLISHED,,xi
00:0001CE  C601D0              +538 	jza	search_chain_tail
00:0001CF  3E02B3              +539 	lcal	display_connection
  :                            540 
  :                            541 search_chain_tail
00:0001D0  50A000              +542 	lx	transmission:next
00:0001D1  700002              +543 	tz	x
00:0001D2  B601C6              +544 	j	search_chain_next
  :                            545 
00:0001D3  8D0001              +546 	ay	1,,xi
00:0001D4  FE01D6              +547 	jyge	search_next_port
00:0001D5  B601C4              +548 	j	search_chain
  :                            549 
  :                            550 search_next_port
00:0001D6  603017              +551 	la	local_port
00:0001D7  C50001              +552 	aa	1,,xi
00:0001D8  1F3018              +553 	dec	ports
00:0001D9  703018              +554 	tz	ports
00:0001DA  B601BC              +555 	j	search_port
00:0001DB  B60089              +556 	j	request
  :                            557 
00:0001DC  AF0367              +558 states?	mta	('!'*/$word-$byte)
00:0001DD  B601E6              +559 	j	option?
00:0001DE  60301A              +560 	la	restart_port
00:0001DF  C03019              +561 	aa	restart_ports
00:0001E0  F80004              +562 	lc	states	restart_port	a
00:0001E1  F8301A              +562 
00:0001E2  FCF002              +562 
00:0001E3  3E02DF              +562 
00:0001E4  38000F              +562 
00:0001E5  B60089              +563 	j	request
  :                            564 
00:0001E6  AF0368              +565 option?	mta	('^'*/$word-$byte)
00:0001E7  B601F1              +566 	j	stop?
                                	sscanf	data,,xi	$3("%s %ld %ld":0),,xi	command_byte,,xi	;
                                							interval,,xi		;
00:0001E8  FD3022              +569 							tx_interval,,xi
00:0001E9  FD3020              +569 
00:0001EA  FD3013              +569 
00:0001EB  FD31C5              +569 
00:0001EC  FD30AF              +569 
00:0001ED  FCF005              +569 
00:0001EE  FF0359              +569 
00:0001EF  38000F              +569 
00:0001F0  B60089              +570 	j	request
  :                            571 
00:0001F1  AF0369              +572 stop?	mta	('.'*/$word-$byte)
00:0001F2  B60089              +573 	j	request
00:0001F3  3D0000              +574 away	fret	0
  :                            575 
  :                            576 
00:0001F4  4D5018              +577 msg_tcp	lk	05000++TCP_ACK++TCP_PSH,,xi
  :                            578 
  :                            579 .	push	05018,,xi
  :                            580 .	pop	SOCKET_CALL_FLAGS
00:0001F5  F80002              +581 	push	x
  :                            582 .	sb	q
00:0001F6  FF036A              +583 	call	(tcp_tx)
00:0001F7  380002              +584 	pop	x
00:0001F8  350000              +585 	lret	0
  :                            586 
  :                            587 $(3)
  :                            588 
  :                            589 rx_ports	$res	1
  :                            590 rx_local_port	$res	1
  :                            591 
03:003121  002800              +592 sockets	$socket_array	10240:10240+2048
03:003122  003000              +592 
03:003123  002800              +592 
03:003124  000804              +592 
03:003125  000804              +592 
  :                            593 
03:003126  002800 002BE8        +594 ?	$do	RX_THREADS,rxport_range(?)	+	10240+?*RX_RANGE-RX_RANGE, 10240+?*RX_RANGE:L
03:003128  002BE8 002FD0        +594 
03:00312A  002FD0 0033B8        +594 
03:00312C  0033B8 0037A0        +594 
03:00312E  0037A0 003B88        +594 
03:003130  003B88 003F70        +594 
03:003132  003F70 004358        +594 
03:003134  004358 004740        +594 
03:003136  000000 000000        +595 ?	$do	RX_THREADS,total_rx(?)		0L
03:003138  000000 000000        +595 
03:00313A  000000 000000        +595 
03:00313C  000000 000000        +595 
03:00313E  000000 000000        +595 
03:003140  000000 000000        +595 
03:003142  000000 000000        +595 
03:003144  000000 000000        +595 
  :                            596 
  :                            597 $(0)
  :                            598 
00:0001F9  50836B              +599 qreadq	lx	*(BSOCKET*/12++tlist:rxbu_p)
00:0001FA  F80003              +600 	push	y
00:0001FB  700002              +601 	tz	x
00:0001FC  FF036C              +602 	call	(if_sell1)
00:0001FD  380003              +603 	pop	y
00:0001FE  350000              +604 	lret	0
  :                            605 
  :                            606 	$list		2
  :                            607 
  :                            608 rthreads $tree
  :                            609: 	$include	rxrotary
  :                            1 
  :                            2 RXROTARY_OVERSTEP $equ	0
  :                            3 
  :                            4 $(66::,sp)
42:000000                     +5 sockets	$socket_array
42:000001                     +5 
42:000002                     +5 
42:000003                     +5 
42:000004                     +5 
  :                            6 
  :                            7 $(0)
  :                            8 rx_thread
                                	$head_near	scalars(total_rxp,	int,	a	;
                                				payloadsegs,	long		;
                                				response_segs,	long		;
00:0001FF  F80004              +12 				sox,		6		)
00:000200  9F036D              +12 
00:000201  9F036D              +12 
00:000202  8F036F              +12 
00:000203  9FF000              +12 
  :                            13 
  :                            14 TOTAL_RX	$equf	RX_THREADS*2, x
  :                            15 TOTAL_TX	$equf	RX_THREADS*2*2, x
  :                            16 
  :                            17 .	sa	total_rxp
  :                            18 
00:000204  CFC000              +19 	dl	0, a			. param -> start of struc aocket_array	
00:000205  C7F000              +20 	ds	sockets:first
00:000206  20F002              +21 	sa	sockets:actual
00:000207  D80004              +22 	anb	a			. limit - 1st
  :                            23 	$do	RXROTARY_OVERSTEP^=0,	ab	RXROTARY_OVERSTEP,,xi
00:000208  28F003              +24 	sb	sockets:span
00:000209  28F004              +25 	sb	sockets:span_restart
  :                            26 
00:00020A  FD0000              +27 	c	(hvsocket_xbind)	sockets:first	sockets:limit	0,,xi
00:00020B  F8F002              +27 
00:00020C  F8F002              +27 
00:00020D  FCF003              +27 
00:00020E  FF0373              +27 
00:00020F  38000F              +27 
  :                            28 
00:000210  650020              +29 	la	ACTIVATE,,xi
00:000211  75005C              +30 	ii	EVENT_WAIT$		. up to here is inital
  :                            31 					. and from here is process loop
00:000212  F8F002              +32 next	lc	socket_respond	sockets:actual
00:000213  FCF001              +32 
00:000214  3E0237              +32 
00:000215  38000F              +32 
00:000216  C6021C              +33 	jza	forward
  :                            34 
  :                            35 	$if	total_tx()
  :                            36 	sa	6
  :                            37 	la	0,,xi
  :                            38 	da	response_segs
  :                            39 	ds	response_segs
  :                            40 	la	6
  :                            41 	$endif
  :                            42 
00:000217  160018              +43 	dsr	24
00:000218  D7F008              +44 	da	payloadsegs
00:000219  C7F008              +45 	ds	payloadsegs
  :                            46 
00:00021A  60F004              +47 	la	sockets:span_restart	. + results so circulate
00:00021B  20F003              +48 	sa	sockets:span		. at least to here before chilling
  :                            49 
00:00021C  50F002              +50 forward	lx	sockets:actual
00:00021D  850001              +51 	ax	1,,xi
00:00021E  40F001              +52 	lr	sockets:limit
00:00021F  F60221              +53 	jxl	span?
00:000220  B60222              +53 
  :                            54 
00:000221  50F000              +55 	lx	sockets:first		. restart table pointer
  :                            56 	
00:000222  10F002              +57 span?	sx	sockets:actual		. completely circled + a few slots
00:000223  1FF003              +58 	dec	sockets:span		. without + results?
00:000224  70F003              +59 	tz	sockets:span	
00:000225  B60212              +60 	j	next			. no
  :                            61 
  :                            62 	$if	RX_THREADS>1
00:000226  CFF008              +63 	dl	payloadsegs
00:000227  7C0232              +64 	jdz	quiet
00:000228  50F00A              +65 	lx	total_rxp
00:000229  D7A010              +66 	da	TOTAL_RX
00:00022A  C7A010              +67 	ds	TOTAL_RX
  :                            68 
  :                            69 	$if	total_tx()
  :                            70 	dl	response_segs
  :                            71 	da	TOTAL_TX
  :                            72 	ds	TOTAL_TX
  :                            73 	$endif
  :                            74 
00:00022B  9FF008              +75 	lc	summarise	payloadsegs,,long
00:00022C  FCF002              +75 
00:00022D  3E0242              +75 
00:00022E  38000F              +75 
  :                            76 
00:00022F  160030              +77 	dsr	48
00:000230  C7F008              +78 	ds	payloadsegs
00:000231  C7F006              +79 	ds	response_segs
  :                            80 
  :                            81 	$else	
  :                            82 	lcal	summarise
  :                            83 	$endif
  :                            84 
00:000232  CF0374              +85 quiet	dl	(ACTIVATE++TIME_WAIT, 50d)		. yes
00:000233  75005C              +86 	ii	EVENT_WAIT$
00:000234  60F004              +87 	la	sockets:span_restart
00:000235  20F003              +88 	sa	sockets:span
00:000236  B60212              +89 	j	next
  :                            610 	$root
  :                            611 
  :                            612: 	$include	respond
  :                            1 
  :                            2 socket_respond
                                	$head_near	 params(sockets_actual,	int)	;
                                							;
00:000237  FD0000              +5 			scalars(activity,	int)	
  :                            6 					
00:000238  60F003              +7 	la	sockets_actual
00:000239  FF0360              +8         call    (connection_array)
00:00023A  B60240              +9         j       sockets_readx
  :                            10 	
  :                            11 segment?
00:00023B  FF0376              +12         call    (hvsocket_readq)                . rx segments all connections this port
  :                            13                                                 . are on 1 rx queue
00:00023C  C60240              +14         jza     sockets_read
00:00023D  3E01F9              +15         lcal    qreadq
  :                            16 
00:00023E  17F000              +17 	inc	activity
00:00023F  B6023B              +18         j       segment?
  :                            19 
  :                            20 sockets_read
  :                            21 .	lb	activity
  :                            22 .	jzb	sockets_readx
  :                            23 .	la	0,,xi
  :                            24 .	da	payload_segments
  :                            25 .	ds	payload_segments
  :                            26 
  :                            27 sockets_readx
00:000240  380004              +28 	pop	a
00:000241  350000              +29 	lret	0
  :                            30 
  :                            613: 	$include	summary
  :                            1 
  :                            2 	$if	RX_THREADS>1
  :                            3 $(3)
03:003146  000000              +4 summary_lock	0
  :                            5 
  :                            6 $(0)
  :                            7 summarise	$head_near	 params(increment,	long)
  :                            8 
00:000242  CF3144              +9 	dl	total_rx(RX_THREADS)
00:000243  D73136              +10 ?	$do	RX_THREADS-1,	da	total_rx(?)
00:000244  D73138              +10 
00:000245  D7313A              +10 
00:000246  D7313C              +10 
00:000247  D7313E              +10 
00:000248  D73140              +10 
00:000249  D73142              +10 
  :                            11 
00:00024A  073146              +12 	ts	summary_lock
00:00024B  3E0255              +13 	lcal	retry		. all threads use 1 stdout handle
  :                            14 
00:00024C  9F0004              +15 	printf	$3("rx @ socket %ld -> %ld":LF:0),,xi	increment,,long	a,,long
00:00024D  9FF004              +15 
00:00024E  FD31C9              +15 
00:00024F  FD0001              +15 
00:000250  FCF006              +15 
00:000251  FF0352              +15 
00:000252  38000F              +15 
  :                            16 
00:000253  303146              +17 	z	summary_lock
00:000254  350000              +18 	$ret	
  :                            19 
00:000255  750041              +20 retry	ii	YIELD$
00:000256  35FFFE              +21 	lret	-2		. back to ts instructiom
  :                            22 
  :                            23 	$else
  :                            24 
  :                            25 summarise
  :                            26 	dl	payload_segments
  :                            27         jdz     summarised
  :                            28         da      total_rx(1)
  :                            29         ds      total_rx(1)
  :                            30         printf  $3("rx @ socket %ld -> %ld":10:0),,xi   payload_segments,,long a,,long
  :                            31         dsr     48
  :                            32         ds      payload_segments
  :                            33 
  :                            34 summarised
  :                            35 	lret	0
  :                            36 
  :                            37 	$endif
  :                            614: 	$include	sdisplay
  :                            1 
  :                            2 .	x -> descriptor [ structure acw ]
  :                            3 
  :                            4 display_segment	$tree
                                	$head_near	 params(qheadp,			int)	;
                                								;
                                			scalars(save_rkxy,	float,	r	;
00:000257  8F0000              +8 				save_bsocket,	int		)
00:000258  FD0000              +8 
  :                            9 
00:000259  65002F              +10 	la	BSOCKET,,xi
00:00025A  750073              +11 	ii	A$IDX
  :                            12 
00:00025B  20F000              +13 	sa	save_bsocket
00:00025C  E602A0              +14 	jna	quit			. basing zero or C00001
00:00025D  C602A0              +15 	jza	quit			. crashes you
  :                            16 
  :                            17 superpage	$equf	0, sp
  :                            18 caller_x	$equf	1+2, sp
  :                            19 
00:00025E  F8F007              +20 next	printf	$3("":LF:"axw @ %x:%x":LF:0),,xi	a	qheadp
00:00025F  F80004              +20 
00:000260  FD31D1              +20 
00:000261  FD0001              +20 
00:000262  FCF004              +20 
00:000263  FF0352              +20 
00:000264  38000F              +20 
  :                            21 
00:000265  60F000              +22 	la	save_bsocket		. printf closes window BSOCKET
00:000266  34002F              +23 	sabr	BSOCKET			. x -> this window
  :                            24 
00:000267  60F007              +25 	la	qheadp
                                	printf	$3("[%x:%x:%x:%x:%x:%x:%x:%x]":LF:0),,xi	0, a	1, a	2, a	3, a	;
00:000268  F8C007              +27 								4, a	5, a	6, a	7, a
00:000269  F8C006              +27 
00:00026A  F8C005              +27 
00:00026B  F8C004              +27 
00:00026C  F8C003              +27 
00:00026D  F8C002              +27 
00:00026E  F8C001              +27 
00:00026F  F8C000              +27 
00:000270  FD31D6              +27 
00:000271  FD0001              +27 
00:000272  FCF00A              +27 
00:000273  FF0352              +27 
00:000274  38000F              +27 
00:000275  60F000              +28 	la	save_bsocket
00:000276  34002F              +29 	sabr	BSOCKET
  :                            30 
00:000277  60F007              +31 	la	qheadp
00:000278  60C001              +32 	la	descriptor:frame, a
  :                            33 
                                	printf	$3("routing header":LF:;
                                		 "%x %x %x %x %x %x %x %x":LF:;
                                		 "%x %x %x %x %x %x %x %x":LF:"datagram":LF:0),,xi		;
                                		  0,a	  1,a	  2,a	  3,a	  4,a	  5,a	  6,a	  7,a	;
00:000279  F8C00F              +38 		8+0,a	8+1,a	8+2,a	8+3,a	8+4,a	8+5,a	8+6,a	8+7,a
00:00027A  F8C00E              +38 
00:00027B  F8C00D              +38 
00:00027C  F8C00C              +38 
00:00027D  F8C00B              +38 
00:00027E  F8C00A              +38 
00:00027F  F8C009              +38 
00:000280  F8C008              +38 
00:000281  F8C007              +38 
00:000282  F8C006              +38 
00:000283  F8C005              +38 
00:000284  F8C004              +38 
00:000285  F8C003              +38 
00:000286  F8C002              +38 
00:000287  F8C001              +38 
00:000288  F8C000              +38 
00:000289  FD31DF              +38 
00:00028A  FD0001              +38 
00:00028B  FCF012              +38 
00:00028C  FF0352              +38 
00:00028D  38000F              +38 
  :                            39 
00:00028E  60F000              +40 	la	save_bsocket
00:00028F  34002F              +41 	sabr	BSOCKET
  :                            42 
00:000290  50F007              +43 	lx	qheadp
00:000291  50A004              +44 	lx	descriptor:dgram, x
00:000292  68A001              +45 	lb	dgram:bytes, x
00:000293  CDFFFF              +46 	ab	-1,,xi
00:000294  AE0296              +47 	jpb	$+2
00:000295  6D0047              +48 	lb	72-1,,xi		. if the length is junk show 2 headings + 32 bytes			
00:000296  E80377              +49 	mf	(R24)			. 24-octet chunkarettes @ 2 octets per socket word
  :                            50 
00:000297  400004              +51 	lr	a			. chunkarettes - 1
  :                            52 
00:000298  3E02A3              +53 get_in	lcal	tae_it			. subroutined out because freehand stack work
00:000299  60F000              +54 	la	save_bsocket		. does not mix with equated stack offsets
00:00029A  34002F              +55 	sabr	BSOCKET			. get the connections / buffers page back
00:00029B  1E0298              +56 	jdr	get_in
  :                            57 
00:00029C  60F007              +58 	la	qheadp
00:00029D  60C000              +59 	la	descriptor:next, a
00:00029E  20F007              +60 	sa	qheadp
00:00029F  D6025E              +61 	jnza	next
  :                            62 
00:0002A0  380004              +63 quit	pop	a			. return page index[BSOCKET]
00:0002A1  870000              +64 	qpop	r			. restore caller [ r k x y ] sp 4++
00:0002A2  350000              +65 	lret	0			.
  :                            66 
00:0002A3  F80000              +67 tae_it	push	r			. printf will mash r and x both
00:0002A4  FCA00C              +68 	push	12, x, i		. next pointer = this pointer + 12 socket buffer words
[buy24_bytes][000000000000000000000000000000000000000000000072]
00:0002A5  64A006              +69 	printf	$3("%Lx":LF:0),,xi	0, x, buy24_bytes
00:0002A6  FF0378              +69 
00:0002A7  8F0004              +69 
00:0002A8  64A000              +69 
00:0002A9  FF0378              +69 
00:0002AA  8F0004              +69 
00:0002AB  FD31F8              +69 
00:0002AC  FD0001              +69 
00:0002AD  FCF00A              +69 
00:0002AE  FF0352              +69 
00:0002AF  38000F              +69 
00:0002B0  380002              +70 	pop	x			. next pointer -> x
00:0002B1  380000              +71 	pop	r
00:0002B2  350000              +72 	lret	0
  :                            73 
  :                            74 		$root
  :                            615: 	$include	cdisplay
  :                            1 .	x -> connection block
  :                            2 
  :                            3 display_connection	$tree
00:0002B3  8F0000              +4 	qpush	r
  :                            5 
00:0002B4  65002F              +6 	la	BSOCKET,,xi
00:0002B5  750073              +7 	ii	A$IDX
00:0002B6  C602DD              +8 	jza	quit
00:0002B7  E602DD              +9 	jna	quit
00:0002B8  F80004              +10 	push	a		. because printf mostly changes BSOCKEZ
  :                            11 
00:0002B9  58A001              +12 	ly	transmission:state
00:0002BA  45000D              +13 	lr	13,,xi
00:0002BB  FE02C6              +14 	jyge	extra_state
  :                            15 
                                	printf	$3("":LF:"tcbloc %x:%x state %d %s":10:0),,xi		0, sp	x	y	;
                                				(names	none						;
                                				closed listen synsent synreceived established finwait1	;
00:0002BC  F8B379              +19 				finwait2 closewait lastack closing timewait deletetcb), y
00:0002BD  F80003              +19 
00:0002BE  F80002              +19 
00:0002BF  F8F003              +19 
00:0002C0  FD3224              +19 
00:0002C1  FD0001              +19 
00:0002C2  FCF006              +19 
00:0002C3  FF0352              +19 
00:0002C4  38000F              +19 
00:0002C5  B602CE              +20 	j	reported
  :                            21 
  :                            22 extra_state
00:0002C6  F80003              +23 	printf	$3("tcbloc %x:%x state %d":10:0),,xi	0, sp	x	y
00:0002C7  F80002              +23 
00:0002C8  F8F002              +23 
00:0002C9  FD322D              +23 
00:0002CA  FD0001              +23 
00:0002CB  FCF005              +23 
00:0002CC  FF0352              +23 
00:0002CD  38000F              +23 
  :                            24 
  :                            25 reported
00:0002CE  60F000              +26 	la	0, sp
00:0002CF  34002F              +27 	sabr	BSOCKET
00:0002D0  8FA014              +28 	printf	$3("%Lx":LF:"%Lx":LF:"%Lx":LF:0),,xi	0,x,float192	8,x,float192	16,x,float192
00:0002D1  8FA010              +28 
00:0002D2  8FA00C              +28 
00:0002D3  8FA008              +28 
00:0002D4  8FA004              +28 
00:0002D5  8FA000              +28 
00:0002D6  FD3235              +28 
00:0002D7  FD0001              +28 
00:0002D8  FCF01A              +28 
00:0002D9  FF0352              +28 
00:0002DA  38000F              +28 
00:0002DB  380004              +29 	pop	a
00:0002DC  34002F              +30 	sabr	BSOCKET
  :                            31 
00:0002DD  870000              +32 quit	qpop	r
00:0002DE  350000              +33 	lret	0
  :                            34 
  :                            35 			$root
  :                            616: 	$include	states
  :                            1 	$if	0
  :                            2 
  :                            3 	these are the states
  :                            4 	____________________
  :                            5 
  :                            6 	static char	*category[] = { "zero",
  :                            7                                         "closed",
  :                            8                                         "listen",
  :                            9                                         "synsent",
  :                            10                                         "synreceived",
  :                            11                                         "established",
  :                            12                                         "finwait1",
  :                            13                                         "finwait2",
  :                            14                                         "closewait",
  :                            15                                         "lastack",
  :                            16                                         "closing",
  :                            17                                         "timewait",
  :                            18                                         "deletetcb",
                                                                        "out of range" } ;
  :                            20 
	and this is how to report them
  :                            21 	______________________________
  :                            22 
                                         for (x = 0; x < 14; x++) tcb_states.bucket[x] = 0;
                                
         y = established;
                                         sscanf(request + 1, "%d", &y);
                                         q = demand;
  :                            27 
         while (y--)
  :                            28          {
                                            x = q->state;
                                            if (x > 13) x = 13;
                                            tcb_states.bucket[x]++;
                                            q++;
  :                            33          }
  :                            34 
                                         for (x = 0; x < 14; x++)
  :                            36          {
                                            if (tcb_states.bucket[x]) printf("%d %s\n", tcb_states.bucket[x], category[x]);
  :                            38          }
  :                            39 
  :                            40          if (payload_segments)
  :                            41          {
                                            printf("payload segments %lld payload %lld\n", payload_segments, payload);
  :                            43          }
  :                            44 
  :                            45 	$endif
  :                            46 
  :                            47 states	$tree
  :                            48 
  :                            49 $(3)
  :                            50 
  :                            51 bucket	$res	14
  :                            52 
  :                            53 $(0)
  :                            54 
                                	$head_near	 params(first_port,	int	;
                                				limit_port,	int)	;
                                							;
00:0002DF  FD0000              +58 			scalars(index,	int		)
  :                            59 
00:0002E0  160030              +60 	dsr	48
00:0002E1  C73147              +61 ?	$do	14/2,	ds	bucket+?*2-2
00:0002E2  C73149              +61 
00:0002E3  C7314B              +61 
00:0002E4  C7314D              +61 
00:0002E5  C7314F              +61 
00:0002E6  C73151              +61 
00:0002E7  C73153              +61 
  :                            62 
00:0002E8  50F003              +63 next	lx	first_port
00:0002E9  17F003              +64 	inc	first_port
00:0002EA  40F004              +65 	lr	limit_port
00:0002EB  F602FD              +66 	jxge	all_states_counted
  :                            67 
00:0002EC  600002              +68 	la	x
00:0002ED  FF0360              +69 	call	(connection_array)
00:0002EE  B602E8              +70 	j	next			. wrong sort of connection table
  :                            71 
00:0002EF  500386              +72 	lx	(BSOCKET*/18++tlist:connection_block(2)s)
  :                            73 
  :                            74 connection
00:0002F0  408387              +75 	lr	*(+(BSOCKET*/18++tlist:top)s)
00:0002F1  F602E8              +76 	jxge	next			. next port
  :                            77 
00:0002F2  58A001              +78 	ly	transmission:state
00:0002F3  780003              +79 	tp	y			. can momentarily be inverted
00:0002F4  0F0003              +80 	n	y			. when transitioning to close
00:0002F5  45000E              +81 	lr	14,,xi			. saturation point+ = nonsense
00:0002F6  FE02F8              +82 	jyl	in_range
00:0002F7  B602F9              +82 
00:0002F8  5D000D              +83 	ly	14-1,,xi
  :                            84 
  :                            85 in_range
00:0002F9  8D3147              +86 	ay	bucket,,xi
00:0002FA  17B000              +87 	inc	0, y			. count[state]++
  :                            88 
00:0002FB  850018              +89 	ax	24,,xi			. next connection
00:0002FC  B602F0              +90 	j	connection
  :                            91 
  :                            92 all_states_counted
00:0002FD  50F000              +93 	lx	index
00:0002FE  17F000              +94 	inc	index
00:0002FF  45000E              +95 	lr	14,,xi
00:000300  F6030D              +96 	jxge	all_states_reported
00:000301  580002              +97 	ly	x
00:000302  853147              +98 	ax	bucket,,xi
00:000303  60A000              +99 	la	0, x
00:000304  C602FD              +100 	jza	all_states_counted
  :                            101 
                                	printf	$3("%d %s":LF:0),,xi	a	(names	zero	closed 		;
                                							listen	synsent		;
                                							synreceived established	;
                                							finwait1 finwait2	;
                                							closewait lastack	;
                                							closing	timewait	;
00:000305  F8B388              +108 							delete_tcb out_of_range), y
00:000306  F80004              +108 
00:000307  FD3245              +108 
00:000308  FD0001              +108 
00:000309  FCF004              +108 
00:00030A  FF0352              +108 
00:00030B  38000F              +108 
00:00030C  B602FD              +109 	j	all_states_counted
  :                            110 
  :                            111 all_states_reported
00:00030D  CF30AA              +112 	dl	payload_segments
00:00030E  7C0315              +113 	jdz	all_reported
  :                            114 
00:00030F  9F0004              +115 	printf	$3("%ld":LF:0),,xi	a,,long
00:000310  FD3248              +115 
00:000311  FD0001              +115 
00:000312  FCF004              +115 
00:000313  FF0352              +115 
00:000314  38000F              +115 
  :                            116 
  :                            117 all_reported
00:000315  FCF001              +118 	$ret
00:000316  38000F              +118 
00:000317  350000              +118 
  :                            119 
  :                            120 	$root
  :                            121 
  :                            617: 	$include	netascan
  :                            1 netascan	$tree
  :                            2 
                                	$head_near	 params(textp,	int)	;
                                						;
00:000318  8F036F              +5 			scalars(neta,	float	)
  :                            6 
                                	sscanf	textp	$3("%d.%d.%d.%d":0),,xi	neta,,i		;
                                						neta+1,,i	;
                                						neta+2,,i	;
00:000319  FCF003              +10 						neta+3,,i
00:00031A  FCF003              +10 
00:00031B  FCF003              +10 
00:00031C  FCF003              +10 
00:00031D  FD324A              +10 
00:00031E  F8F00B              +10 
00:00031F  FCF006              +10 
00:000320  FF0359              +10 
00:000321  38000F              +10 
  :                            11 
00:000322  4D00FF              +12 	lk	255,,xi
00:000323  CFF000              +13 	dl	neta
00:000324  2E0008              +14 	sbl	8
00:000325  BFF002              +15 	mlb	neta+2
00:000326  2E0008              +16 	sbl	8
00:000327  BFF003              +17 	mlb	neta+3
00:000328  360010              +18 	dsl	16
00:000329  FCF004              +19 	$ret	0
00:00032A  38000F              +19 
00:00032B  350000              +19 
  :                            20 
  :                            21 		$root
  :                            618 
  :                            619 	$do	$<256,$(0:256)
*EOF*
00:00032c+[0001]18:000000
00:00032d+00C000
00:00032e+[0003]30:000000000000
00:000330+0001CD
00:000331+00010E
00:000332+0001FF00000000312600BC00
00:000336+0001FF00000000312800B800
00:00033a+0001FF00000000312A00B400
00:00033e+0001FF00000000312C00B000
00:000342+0001FF00000000312E00AC00
00:000346+0001FF00000000313000A800
00:00034a+0001FF00000000313200A400
00:00034e+0001FF00000000313400A000
00:000352+0001DB
00:000353+0001D6
00:000354+0001E4
00:000355+000202
00:000356+00020D
00:000357+FF0000
00:000358+2B0000
00:000359+0001D8
00:00035a+00FFFF
00:00035b+000083
00:00035c+000000010000
00:00035e+3E0000
00:00035f+0001D9
00:000360+000135
00:000361+02F008
00:000362+000000000001
00:000364+02F028
00:000365+3C0000
00:000366+3F0000
00:000367+210000
00:000368+5E0000
00:000369+2E0000
00:00036a+0000B1
00:00036b+02F003
00:00036c+00009A
00:00036d+000000000000
00:00036f+000000000000000000000000
00:000373+000136
00:000374+800020000032
00:000376+000134
00:000377+0AAAAB
00:000378+000116
00:000379+0031FA
0031FC
0031FF
003202
003205
003209
00320D
003210
003213
003217
00321A
00321D
003220
00:000386+BC0040
00:000387+BC0002
00:000388+00323A
0031FC
0031FF
003202
003205
003209
00320D
003210
003213
003217
00321A
00321D
00323C
003240
03:003155+70726F746F6E5F7278283129000000
03:00315a+70726F746F6E5F7278283229000000
03:00315f+70726F746F6E5F7278283329000000
03:003164+70726F746F6E5F7278283429000000
03:003169+70726F746F6E5F7278283529000000
03:00316e+70726F746F6E5F7278283629000000
03:003173+70726F746F6E5F7278283729000000
03:003178+70726F746F6E5F7278283829000000
03:00317d+70726F746F6E3E0000
03:003180+253A3A257300
03:003182+253A2F257300
03:003184+25642F25642F256420256400
03:003188+636F6E6E6563742072657475726E20256C640A0000
03:00318f+0D20256C6420000000
03:003192+257320256420257300
03:003195+256420257300
03:003197+256420747820256C640A0000
03:00319b+207278207365676D656E74206177616974696E6720736571
75656E636500
03:0031a5+20554E5452414E534D495454454400
03:0031aa+206177616974696E67205443505F41434B00
03:0031b0+207278207472616666696320617420736F636B6574000000
03:0031b8+0A636F6E6E656374696F6E2025783A257820686173207365
676D656E745B735D2025730A000000
03:0031c5+257320256C6420256C640000
03:0031c9+7278204020736F636B657420256C64202D3E20256C640A00
03:0031d1+0A61787720402025783A25780A0000
03:0031d6+5B25783A25783A25783A25783A25783A25783A25783A2578
5D0A00
03:0031df+726F7574696E67206865616465720A257820257820257820
25782025782025782025782025780A257820257820257820
25782025782025782025782025780A646174616772616D0A
000000
03:0031f8+254C780A0000
03:0031fa+6E6F6E650000
03:0031fc+636C6F736564000000
03:0031ff+6C697374656E000000
03:003202+73796E73656E740000
03:003205+73796E726563656976656400
03:003209+65737461626C697368656400
03:00320d+66696E776169743100
03:003210+66696E776169743200
03:003213+636C6F736577616974000000
03:003217+6C61737461636B0000
03:00321a+636C6F73696E670000
03:00321d+74696D657761697400
03:003220+64656C657465746362000000
03:003224+0A7463626C6F632025783A25782073746174652025642025
730A00
03:00322d+7463626C6F632025783A25782073746174652025640A0000
03:003235+254C780A254C780A254C780A000000
03:00323a+7A65726F0000
03:00323c+64656C6574655F7463620000
03:003240+6F75745F6F665F72616E6765000000
03:003245+25642025730A000000
03:003248+256C640A0000
03:00324a+25642E25642E25642E256400
:$(00):000000:000396 :$(02):002000:003000 :$(03):003000:00324E :$(42):000000:000005 :$(45):000000:000008 :$(47):000000:00000A 
proton.msm: object code 9351 bytes: 0 errors: 4 undefined labels
